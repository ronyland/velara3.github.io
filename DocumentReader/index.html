<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <!-- Generator: Radiate 4.7.8, HTML Exporter, http://www.velara3.com -->
        <title>Speech Software 2000</title>
		<!--header_start-->
		<!--header_end-->
		<!--scripts_start-->
		<!--scripts_end-->
		<!--stylesheets_start-->
		<!--stylesheets_end-->
		<!--styles_start-->
		<style type="text/css">

		#RichText1786  {
			position:absolute;
			top:20px;
			left:20px;
			margin-top:-0.2em;
      font-size: 32px;
      font-family: Trattatello, Georgia, "Garamond", Oxygen, Source Sans Pro, "Helvetica Neue",Helvetica,"Century Schoolbook",Arial,sans-serif;
		}

		#RichText1786 > :first-child {
			margin-top:0px;
		}

		#textarea  {
			position:absolute;
			top:110px;
			bottom:120px;
			left:20px;
			right:20px;
			width:760px;
      height: calc(100% - 220px);
			display:inline-block;
			margin-top:-0.2em;
      padding: 60px;
      padding-bottom: 60px;
      margin: 0 auto;
      border: 1px solid #EEEEEE;
      -webkit-box-shadow: 1px 1px 1px 0px rgba(50, 50, 50, 0.75);
      -moz-box-shadow:    1px 1px 1px 0px rgba(50, 50, 50, 0.75);
      box-shadow:         1px 1px 1px 0px rgba(50, 50, 50, 0.10);
      font-family: Georgia, "Garamond", Oxygen, Source Sans Pro, "Helvetica Neue", Helvetica, "Century Schoolbook", Arial, sans-serif;
      line-height: 160%;
      letter-spacing: .8px;
		}

    #textarea:focus  {
      outline: none;
      border:1px solid #EEEEEE;
    }

		#textarea > :first-child {
			margin-top:0px;
		}

		#HGroup2925  {
			position:absolute;
			bottom:0px;
			left:0px;
			min-width:20px;
			min-height:10px;
			overflow:visible;
			text-align:left;
      background-color: white;
      padding: 10px;
      padding-left: 20px;
      width: calc(100%);
      border-top: 1px solid #dedede;
		}

  	#settingsWindow  {
			position:absolute;
      display: none;
			bottom:42px;
			right:0px;
			min-width:20px;
			min-height:10px;
			overflow:visible;
			text-align:left;
      background-color: white;
      padding: 20px;
      width: calc(250px);
      border-top: 1px solid #dedede;
      border-left: 1px solid #dedede;
      border-right: 1px solid #dedede;
      border-bottom: 1px solid #dedede;
      font-family: Source Sans Pro, Oxygen, sans-serif;
      font-size: 80%;
      letter-spacing: .3px;
  	}

  	#shareWindow  {
			position:absolute;
      display: block;
			top:2px;
			left:50%;
			min-width:20px;
			min-height:10px;
			overflow:visible;
			text-align:left;
      background-color: white;
      padding: 20px;
      width: calc(450px);
      border-top: 1px solid #dedede;
      border-left: 1px solid #dedede;
      border-right: 1px solid #dedede;
      border-bottom: 1px solid #dedede;
      font-family: Source Sans Pro, Oxygen, sans-serif;
      font-size: 80%;
      letter-spacing: .3px;
      transform: translateX(-50%);
  	}

    input[type="button"] {
      border: .1px solid #DFDFDF;
      padding: 2px 6px;
      cursor: pointer;
      margin-right:8px;
      background-color: #F6F6F6;
    }

    input[type="button"]:active {
      background-color:#DEDEDE;
      font-weight: "bold";
    }

		#playButton  {
			position:relative;
			display:inline-block;
			vertical-align:middle;
		}

		#pauseButton  {
			position:relative;
			vertical-align:middle;
			display:inline-block;
			display:none;
		}

		#resumeButton  {
			position:relative;
			vertical-align:middle;
			display:inline-block;
			display:none;
		}

		#stopButton  {
			position:relative;
			display:inline-block;
			vertical-align:middle;
		}

		#clearRegionButton  {
			position:relative;
			vertical-align:middle;
			display:inline-block;
			display:none;
		}

		#settingsButton  {
			position:relative;
			display:inline-block;
			vertical-align:middle;
      float: right;
      font-size: 120%;
      color: #8F8F8F;
      cursor:pointer;
		}

		#shareButton  {
			position:relative;
			display:inline-block;
			vertical-align:middle;
      cursor:pointer;
		}

    #settingsButton:active {
      color: #CFCFCF;
		}

		#cursorLabel  {
			position:relative;
			display:inline-block;
			vertical-align:middle;
      float: right;
      font-size: 90%;
      color: #BDBDBD;
      cursor:pointer;
      padding-right: 20px;
		}


		*, *:before, *:after {
			-moz-box-sizing:border-box;
			-webkit-box-sizing:border-box;
			box-sizing:border-box;
			margin:0;
			padding:0;
		}

		html, body {
			width:100%;
			height:100%;
			margin:0;
			padding:0;
      font-family: Georgia, Helvetica Neue, Helvetica, Verdana;
      background-color: #F6F6F6;
		}


		</style>
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->
		<!--styles_end-->
    </head>
    <body>
		<!--body_start-->
		<div id="RichText1786">
      <img src="assets/logo.png"/>
		</div>
		<textarea id="textarea" placeholder="Enter text to be spoken"></textarea>
		<div id="HGroup2925">
			<input id="playButton" type="button" value="Play" title="Play the text in the text area. Note: Occassionally it's necessary to reload the page."/>
			<input id="rewindButton" type="button" value="Rewind"/>
			<input id="pauseButton" type="button" value="Pause"/>
			<input id="resumeButton" type="button" value="Resume"/>
			<input id="stopButton" type="button" value="Stop"/>
			<input id="clearRegionButton" type="button" value="Clear selected region"/>
			<input id="reloadButton" type="button" value="Reload" title="Occasionally it's necessary to reload the page"/>
      <noscript>
        <span >You must enable JavaScript for this page to work</span>
      </noscript>
      <span style="padding-left:10px;padding-right:18px;color:#CFCFCF;">|</span>
			<input id="shareButton" type="button" value="Share" title="Creates a URL that you can send to someone or yourself."/>
      <img id="settingsButton" src="assets/cog.png"/>
      <span id="cursorLabel"></span>
			<span style='display:inline-block;height:100%;width:0;vertical-align:middle;'></span>
		</div>

    <div id="settingsWindow">
      <span>Settings are under construction. <br><br>They will be added if you send me a nice email or note.</span>
      <span><br><br>Email is "contact" at velara3 dot com.</span>
      <br>
      <br>
      <select id="voicesSelect"></select>
    </div>

    <div id="shareWindow">
      <div><span>Share the message!</span><span id="closeShareWindowButton" style="float:right;font-weight:bold;cursor: pointer" onclick="closeShareWindow()">X</span></div>
      <br>
      <div>URL:
        <input id="shareURLInput" type="text" style="width:80%" />
        <input id="copyToClipboardButton" type="button" value="Copy" title="Copy URL to clipboard" onclick="copyURLHandler(event)"/></div>
      <br>
      <div>Autoplay: <input id="autoplayCheckbox" type="checkbox" checked="false" />
        <span id="clipboardMessageLabel" style="float:right;"></span></div>
      <!--<br>
      <div>Play at current location: <input id="playAtCurrentLocation" type="checkbox" /></div>-->
    </div>

		<script>
    class MainForm {

      constructor() {
        this.utterance = new SpeechSynthesisUtterance();
        this.pauseIndex = 0;
        this.application = {};
        this.playbackSpeed = 1;
        this.language = null;
        this.voice = null;
        this.voices = [];
        this.startPosition = null;
        this.endPosition = null;
        this.isInitialized = false;
        this.autoPlay = false;

        // form
        this.textarea = null;
        this.playButton = null;
        this.reloadButton = null;
        this.cursorLabel = null;
        this.settingsButton = null;
        this.shareButton = null;
        this.settingsWindow = null;
        this.shareWindow = null;
        this.autoplayCheckbox = null;
        this.voicesSelect = null;
      }
    }

    var mainForm = new MainForm();
    var utterance = new SpeechSynthesisUtterance();
    var pauseIndex = 0;
    var application = {};
    var playbackSpeed = 1;
    var language = null;
    var voice = null;
    var voiceObject = null;
    var voices = [];
    var startPosition = null;
    var endPosition = null;
    var isInitialized = false;
    var autoPlay = false;

    log = console.log;

		utterance.lang = "";
		utterance.rate = 1;

		textarea = document.getElementById('textarea');
		playButton = document.getElementById('playButton');
		reloadButton = document.getElementById('reloadButton');
		cursorLabel = document.getElementById('cursorLabel');
		settingsButton = document.getElementById('settingsButton');
		shareButton = document.getElementById('shareButton');
		autoplayCheckbox = document.getElementById('autoplayCheckbox');
		settingsWindow = document.getElementById('settingsWindow');
		voicesSelect = document.getElementById('voicesSelect');

    playButton.onclick = playHandler;
    textarea.onmouseup = selectionHandler;
    textarea.onmousedown = selectionHandler;
    cursorLabel.onclick = cursorLocationChangeHandler;
    reloadButton.onclick = reloadHandler;
    settingsButton.onclick = settingsHandler;
    shareButton.onclick = shareHandler;
    voicesSelect.onchange = voicesHandler;
    autoplayCheckbox.onchange = autoplayHandler;

    function voicesHandler(event) {
      var voiceName = voicesSelect.selectedOptions[0].getAttribute('data-name');
      voices = speechSynthesis.getVoices();

      for(var i = 0; i < voices.length; i++) {

        if(voices[i].name === voiceName) {
          voice = voiceName;
          voiceObject = voices[i];
        }
      }
    }

    function settingsHandler() {
      var display = settingsWindow.style.display;
      var visible = display!="none" && display!="";
      settingsWindow.style.display = visible ? "none" : "block";

      if (voicesSelect.options.length==0) {
        loadVoices();
      }
    }

    function shareHandler() {
      var display = shareWindow.style.display;
      var isVisible = display!="none" && display!="";

      shareWindow.style.display = isVisible ? "none" : "block";
      
      shareURLInput.value = getShareURL();
    }
    
    function autoplayHandler() {
      autoPlay = autoplayCheckbox.checked;
      shareURLInput.value = getShareURL();
    }

    function closeShareWindow() {
      shareWindow.style.display = "none";
      clipboardMessageLabel.textContent = "";
    }
    
    async function copyURLHandler(event = null) {
      var url = shareURLInput.value;
      
      try {
        log(event);
        if (event.shiftKey) {
          window.open(url);
          clipboardMessageLabel.textContent = "URL opened in a new window";
          return;
        }
        await navigator.clipboard.writeText(url);
        clipboardMessageLabel.textContent = "URL copied to the Clipboard";
      }
      catch (error) {
        clipboardMessageLabel.textContent = "Error: URL not copied to the Clipboard.\n";
        clipboardMessageLabel.textContent += error;
      }
    }

    function getShareURL() {
      var url = "";
      var text = textarea.value;
      var parameters = [];
      var autoPlay = autoplayCheckbox.checked;
      
      url = window.location.href.split(/[?#]/)[0];
      log("URL:" + url)
      log("text:" + text)

      if (voice!=null) {
        parameters.push("voice=" + encodeURIComponent(voice));
      }
      
      if (playbackSpeed!=1) {
        parameters.push("speed=" + Number(playbackSpeed) >>> 1);
      }

      if (autoPlay) {
        parameters.push("autoplay=1");
      }

      if (language!=null) {
        parameters.push("lang=" + encodeURIComponent(language));
      }
      
      if (text!=null && text!="") {
        parameters.push("text=" + encodeURIComponent(text));
      }
      
      if (parameters.length) {
        url += "?" + parameters.join("&");
      }
      log("URL:" + url)

      return url;
    }

    function reloadHandler() {
      window.location.reload(false);
    }

    function cursorLocationChangeHandler() {
      var location = cursorLabel.innerHTML;
      var position = Number(location) >>> 0;

      if (!isNaN(position)) {
        textarea.selectionStart = position;
        textarea.selectionEnd = position;
        textarea.focus();
      }
    }

    /**
     * Plays the text to speech. The text area will not show highlighting if a text input in web developer tools have focus
     * */
    function playHandler() {
      var text = textarea.value;
      var hasStart = false;
      var hasEnd = false;
      var lastWord;

      pauseIndex = 0;

      if (startPosition!=null && !isNaN(startPosition)) {
        hasStart = true;
        startPosition = parseInt(startPosition);
      }

      if (endPosition!=null && !isNaN(endPosition)) {
        hasEnd = true;
        endPosition = parseInt(endPosition);
      }

      if (text=="") {
        text = "Please enter some text"
      }
      else if (hasStart || hasEnd) {

          if ("selectionStart" in textarea) {

            // has start and end
            if (hasStart && hasEnd) {
              text = text.substring(startPosition, endPosition);
              pauseIndex = startPosition;
            }
            else if (hasStart) {
              text = text.substring(startPosition, text.length);
              pauseIndex = startPosition;
            }
            else if (hasEnd) {
              text = text.substring(0, endPosition);
              pauseIndex = 0;
            }
          }
      }
      else {
        if (document.selection) {
          // this block not tested
          var range = document.selection.createRange();
        }
        else if (textarea.selectionStart!=null) {
          var selectionStart = textarea.selectionStart;
          var selectionEnd = textarea.selectionEnd;
          lastWord = isLastWord(text, selectionStart);

          // if at end start over
          if (selectionStart==text.length) {
            textarea.selectionStart = 0;
            textarea.selectionEnd = 0;
          }
          else {
            text = text.substring(selectionStart, text.length);
            pauseIndex = selectionStart;
          }
        }
      }

      // create the utterance on play in case user called stop
      // reference https://stackoverflow.com/a/47276578/441016
      utterance = new SpeechSynthesisUtterance();
      utterance.onboundary = onboundaryHandler;
      utterance.onend = onEndHandler;
      utterance.text = text;
      utterance.rate = playbackSpeed;
      utterance.voice = getVoice(voice);
      utterance.lang = getLanguage(language);
      
      // speechSynthesis is an object on the window
      speechSynthesis.speak(utterance);
		};

    function selectionHandler(event) {
      var text = textarea.value;

      if (document.selection) {
          // this block not tested
          var range = document.selection.createRange();
      }
      else if (textarea.selectionStart) {
          var startPos = textarea.selectionStart;
          var endPos = textarea.selectionEnd;

          if (startPos==endPos) {
              setCursorLabel(endPos);
          }
          else {
              setCursorLabel(startPos + "-" + endPos);
          }
      }

		};

		document.getElementById('pauseButton').onclick = function(){
      if (speechSynthesis) {
        speechSynthesis.pause();
      }
		};

		document.getElementById('rewindButton').onclick = function() {
      if (speechSynthesis) {
        resetPosition();
      }
		};

		document.getElementById('resumeButton').onclick = function() {
      if (speechSynthesis) {
        speechSynthesis.resume();
      }
		};

		document.getElementById('stopButton').onclick = function() {
      if (speechSynthesis) {
        speechSynthesis.cancel(); // triggers end event
        textarea.focus();
      }
		};

		document.getElementById('clearRegionButton').onclick = function() {
      clearRegion();
      document.getElementById('clearRegionButton').style.display = "none";
		};

    function onEndHandler(event) {
      var currentPosition = event.charIndex + pauseIndex;
      var text = textarea.value;
      var textLength = text.length;
      var lastWord = isLastWord(text, currentPosition);
      var minTextPosition = textLength - lastWord.length-1;

      // calling speechSynthesis.stop() triggers an end event
      // set end position only at playback end
      if (currentPosition>=minTextPosition) {
          setEndPosition();
      }
    }

		function onboundaryHandler(event) {
      //log ("Event:" + event.type + " index:" + event.charIndex + " length:" + event.charLength)
      var value = textarea.value;
      var index = event.charIndex + pauseIndex;
      var anchorPosition = getWordStart(value, index);
      var word = getWordAt(value, index, event.charLength);
      var activePosition = anchorPosition + word.length;

      if (anchorPosition< index) {
        //log("Punctuation:" + value.slice(index,index+event.charLength));
        return;
      }

      textarea.focus();

      if (textarea.setSelectionRange) {
          textarea.setSelectionRange(anchorPosition, activePosition);
      }
      else {
          // block not tested
          var range = textarea.createTextRange();
          range.collapse(true);
          range.moveEnd('character', activePosition);
          range.moveStart('character', anchorPosition);
          range.select();
      }

      setCursorLabel(index);
		};

		// Get the word of a string given the string and index
		function getWordAt(str, pos, charCount = null) {
      // Perform type conversions.
      str = String(str);
      pos = Number(pos) >>> 0;

      // Search for the word's beginning and end.
      var left = str.slice(0, pos + 1).search(/\S+$/);
      var right = str.slice(pos).search(/\s/);
      var possibleWord = "";
      //log ("start: " + left + " pause index:" + pauseIndex)
      
      // The last word in the string is a special case.
      if (right < 0) {
        str = str.slice(left).match(/\w+/gi)[0];
        return str;
      }
      
      // Return the word, using the located bounds to extract it from the string.
      var guess = str.slice(left, left + charCount);
      var results = str.slice(left, right + pos).match(/\w+/gi)[0];

      if (charCount!=null) {
        //log("left:" + left + " right:" + right + " word:" + results + " guess:" + guess);
        return guess;
      }
      else {
        //log("left:" + left + " right:" + right + " word:" + results)
        return results;
      }
      return results;
		}

		// Get the position of the beginning of the word
		function getWordStart(str, pos) {
      str = String(str);
      pos = Number(pos) >>> 0;

      // Search for the word's beginning
      var start = str.slice(0, pos + 1).search(/\S+$/);
      return start;
		}

		// Get the last word of a string given the string and index
		function isLastWord(str, pos) {
      // Perform type conversions.
      str = String(str);
      pos = Number(pos) >>> 0;

      // Search for the word's beginning and end.
      var left = str.slice(0, pos + 1).search(/\S+$/),
          right = str.slice(pos).search(/\s/);

      // The last word in the string is a special case.
      if (right < 0) {
          return str.slice(left);
      }

      // Return the word, using the located bounds to extract it from the string.
      return str.slice(left, right + pos);
    }

    function resetPosition() {
      var textarea = document.getElementById('textarea');

      if (textarea.selectionStart) {
          textarea.selectionStart = 0;
          textarea.selectionEnd = 0;
          setCursorLabel("0");
          textarea.focus();
      }
    }

    function setEndPosition() {
      var value = textarea.value;
      var endPosition = value.length;

      if (textarea.selectionStart!=null) {
        textarea.selectionStart = endPosition;
        textarea.selectionEnd = endPosition;
        setCursorLabel(endPosition);
      }
    }

    function getVoice(value) {
      var voiceInstance = null;

      if (value!=null) {
        value = value.toLowerCase();
        voices = speechSynthesis.getVoices();

        for(var i=0;i<voices.length;i++) {
          if (voices[i].name.toLowerCase()==value.toLowerCase()) {
            voiceInstance = voices[i];
            return voiceInstance;
          }
        }

        return null;
      }
    }

    function getLanguage(value) {
      return value==null ? "" : value;
    }

    function setCursorLabel(value) {
      cursorLabel.innerHTML = value;
    }

    function clearRegion() {

      if ("selection" in document) {
        startPosition = null;
        endPosition = null;
      }
      else if ("selectionStart" in textarea) {

        if (startPosition!=null) {
          textarea.selectionStart = startPosition;
          textarea.selectionEnd = startPosition;
          setCursorLabel(startPosition);
        }
        else if (endPosition!=null) {
          textarea.selectionStart = endPosition;
          textarea.selectionEnd = endPosition;
          setCursorLabel(endPosition);
        }

        startPosition = null;
        endPosition = null;

        textarea.focus();
      }

    }
    
    function loadVoices() {
      // get available voices
      voices = speechSynthesis.getVoices();

      if (voicesSelect.options.length) {
        voicesSelect.options.length = 0;
      }

      for(i = 0; i < voices.length ; i++) {
        var currentVoice = voices[i];
        var currentVoiceName = currentVoice.name;
        var option = document.createElement('option');
        var isDefault = false;
        if (currentVoice.default) {
          isDefault = true;
        }
        if (voice!=null && voice.toLowerCase()==currentVoiceName.toLowerCase()) {
          option.setAttribute("selected", "");
        }
        else if (currentVoice.default && voice==null) {
          option.setAttribute("selected", "");
        }
        option.textContent = currentVoice.name + ' (' + currentVoice.lang + ')';
        option.textContent += isDefault ? ' (default)' : "";
        option.setAttribute('data-lang', currentVoice.lang);
        option.setAttribute('data-name', currentVoice.name);
        voicesSelect.appendChild(option);
      }
    }
    
    function onloadHandler(event = null) {
      var v = speechSynthesis.getVoices();
      var reg = /[?|&]text=([^&]+)/;
      var found = reg.exec(window.location.href);
      
      if (isInitialized) {
        return;
      }
      
      // if text parameter is found auto fill
      if (found!=null) {
        textarea.value = decodeURIComponent(found[1]);
      }

      // check for playback speed
      reg = /[?|&]speed=([^&]+)/i;
      found = reg.exec(window.location.href);

      if (found!=null && !isNaN(found[1])) {
        playbackSpeed = Number(found[1]);
      }

      // check for language
      reg = /[?|&]language=([^&]+)/i;
      found = reg.exec(window.location.href);

      if (found) {
        language = found[1];
      }

      // check for voice
      reg = /[?|&]voice=([^&]+)/i;
      found = reg.exec(window.location.href);

      if (found) {
        voice = found[1];
      }

      // get available voices
      loadVoices();

      // check for start position
      reg = /[?|&]startPosition=([^&]+)/i;
      found = reg.exec(window.location.href);

      if (found) {
        startPosition = parseInt(found[1]);
      }

      // check for end position
      reg = /[?|&]endPosition=([^&]+)/i;
      found = reg.exec(window.location.href);

      if (found) {
        endPosition = parseInt(found[1]);
      }
      

      // check for auto play. accepts true or 1 to autoplay
      reg = /[?|&]autoplay=([^&]+)/i;
      found = reg.exec(window.location.href);
      autoPlay = found && (found[1]=="1" || found[1]=="true");
      
      isInitialized = true;

      if (autoPlay) {
        playHandler();
      }
    };
    
    window.addEventListener("load", onloadHandler);
    //document.body.addEventListener("load", onloadHandler);
    document.addEventListener("DOMContentLoaded", onloadHandler);
    
		</script>
		<!--body_end-->
    </body>
</html>
